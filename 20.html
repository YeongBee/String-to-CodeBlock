<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Perfect Code Block (Final Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link id="theme-link" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f9; max-width: 1200px; margin: 0 auto; color: #333; }
        .controls { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #666; }
        select, input { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; outline: none; height: 42px; box-sizing: border-box; }
        button { padding: 0 25px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; height: 42px; font-size: 14px; }
        #btn-convert { background: #007bff; }
        #btn-copy { background: #28a745; }
        #btn-example { background: #6f42c1; } /* ì˜ˆì œ ë²„íŠ¼ ìƒ‰ìƒ */

        .container { display: flex; gap: 20px; height: 500px; margin-bottom: 40px; }
        .box { flex: 1; display: flex; flex-direction: column; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .box-header { padding: 12px 15px; background: #f8f9fa; font-weight: bold; color: #555; border-bottom: 1px solid #eee; }
        textarea { width: 100%; height: 100%; border: none; padding: 15px; resize: none; font-family: 'Consolas', monospace; font-size: 13px; outline: none; box-sizing: border-box; }
        #hidden-area { position: absolute; top: -9999px; visibility: hidden; }
        
        #live-preview-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; border: 2px dashed #007bff; min-height: 100px; }
        #live-preview-section h3 { margin-top: 0; color: #007bff; margin-bottom: 15px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }

        .theme-preview-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .theme-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; text-align: center; padding: 10px; font-size: 14px; font-weight: bold; color: #555; background: #f9f9f9; }
        .theme-card:hover { background: #eef; border-color: #aaf; }
        .theme-visual { height: 60px; display: flex; align-items: center; justify-content: center; font-family: monospace; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <h1 style="text-align: center;">Code Block Generator (Dracula JSON & Line Fix)</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>ì–¸ì–´</label>
            <select id="lang-select">
                <option value="java">Java</option>
                <option value="python">Python</option>
                <option value="javascript">JavaScript</option>
                <option value="json">JSON</option>
                <option value="sql">SQL</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="bash">Bash</option>
                <option value="yaml">YAML</option>
            </select>
        </div>
        <div class="control-group">
            <label>í…Œë§ˆ</label>
            <select id="theme-select" onchange="changeTheme()">
                <option value="vs2015">VS 2015 (Dark)</option>
                <option value="github">GitHub (Light)</option>
                <option value="monokai">Monokai (Dark)</option>
                <option value="atom-one-dark">Atom One Dark</option>
                <option value="dracula">Dracula</option>
                <option value="default">Default</option>
            </select>
        </div>
        <div class="control-group">
            <label>ì œëª©</label>
            <input type="text" id="title-input" placeholder="ì˜ˆ: hello.py">
        </div>
        <div class="control-group">
            <label>í°íŠ¸ (px)</label>
            <input type="number" id="font-size-input" value="14" min="10" max="30">
        </div>
        <button id="btn-example" onclick="loadExample()">ğŸ‘‹ ì˜ˆì œ ì½”ë“œ (Hello World)</button>
        <button id="btn-convert" onclick="convertCode()">ë³€í™˜í•˜ê¸°</button>
        <button id="btn-copy" onclick="copyResult()">ê²°ê³¼ ë³µì‚¬</button>
    </div>

    <div class="container">
        <div class="box">
            <div class="box-header">1. ì†ŒìŠ¤ ì½”ë“œ ì…ë ¥</div>
            <textarea id="input-code" placeholder="ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        </div>
        <div class="box">
            <div class="box-header">2. ë³€í™˜ëœ HTML ê²°ê³¼</div>
            <textarea id="output-html" readonly placeholder="ë³€í™˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒì„±ë©ë‹ˆë‹¤."></textarea>
        </div>
    </div>

    <div id="live-preview-section">
        <h3>ğŸ‘ï¸ ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h3>
        <div id="preview-content"><p style="color: #999;">ë³€í™˜ì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p></div>
    </div>

    <div class="theme-preview-section">
        <h3>ğŸ¨ í…Œë§ˆ ë¹ ë¥¸ ì„ íƒ</h3>
        <div class="theme-grid">
            <div class="theme-card" onclick="selectTheme('vs2015')"><div class="theme-visual" style="background:#1e1e1e; color:#dcdcdc;">VS 2015</div></div>
            <div class="theme-card" onclick="selectTheme('github')"><div class="theme-visual" style="background:#ffffff; color:#24292e; border:1px solid #ddd;">GitHub</div></div>
            <div class="theme-card" onclick="selectTheme('monokai')"><div class="theme-visual" style="background:#272822; color:#f8f8f2;">Monokai</div></div>
            <div class="theme-card" onclick="selectTheme('atom-one-dark')"><div class="theme-visual" style="background:#282c34; color:#abb2bf;">Atom One Dark</div></div>
            <div class="theme-card" onclick="selectTheme('dracula')"><div class="theme-visual" style="background:#282a36; color:#f8f8f2;">Dracula</div></div>
            <div class="theme-card" onclick="selectTheme('default')"><div class="theme-visual" style="background:#f0f0f0; color:#444;">Default</div></div>
        </div>
    </div>

    <div id="hidden-area">
        <pre><code id="temp-code"></code></pre>
    </div>

    <script>
        function changeTheme() {
            const theme = document.getElementById('theme-select').value;
            document.getElementById('theme-link').href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${theme}.min.css`;
        }
        
        function selectTheme(themeName) {
            document.getElementById('theme-select').value = themeName;
            changeTheme();
            setTimeout(convertCode, 200);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function loadExample() {
            document.getElementById('lang-select').value = 'python';
            document.getElementById('title-input').value = 'hello_world.py';
            document.getElementById('input-code').value = 'print("Hello, World!")\nprint("This is a test code.")\n# No more empty lines at the start!';
            convertCode();
        }

        function convertCode() {
            const input = document.getElementById('input-code').value;
            // [ì¤‘ìš” ìˆ˜ì •] ì…ë ¥ê°’ ì•ë’¤ ê³µë°± ì œê±° (trim) -> ì²« ì¤„ ë°€ë¦¼ ì›ì²œ ì°¨ë‹¨
            // ë‹¨, ì‚¬ìš©ìê°€ ì˜ë„í•œ ë“¤ì—¬ì“°ê¸°ê°€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ trimLeft ëŒ€ì‹  ì •ê·œì‹ìœ¼ë¡œ 'ì²« ì¤„ë°”ê¿ˆ'ë§Œ ì œê±°
            let cleanInput = input;
            
            // ë§¨ ì•ì˜ ë¶ˆí•„ìš”í•œ ì¤„ë°”ê¿ˆ ì œê±° (ì—°ì†ëœ ì¤„ë°”ê¿ˆ í¬í•¨)
            cleanInput = cleanInput.replace(/^[\r\n]+/, ''); 
            // ë§¨ ë’¤ì˜ ë¶ˆí•„ìš”í•œ ì¤„ë°”ê¿ˆ ì œê±°
            cleanInput = cleanInput.replace(/[\r\n]+$/, ''); 

            if (!cleanInput.trim()) { alert("ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const lang = document.getElementById('lang-select').value;
            const theme = document.getElementById('theme-select').value;
            const title = document.getElementById('title-input').value.trim();
            const fontSize = parseInt(document.getElementById('font-size-input').value);
            const tempCode = document.getElementById('temp-code');

            // 1. í•˜ì´ë¼ì´íŒ…
            tempCode.textContent = cleanInput;
            tempCode.className = `language-${lang}`;
            tempCode.removeAttribute('data-highlighted');
            hljs.highlightElement(tempCode);

            // 2. ìƒ‰ìƒ ì¶”ì¶œ
            const codeStyle = window.getComputedStyle(tempCode);
            let bgColor = codeStyle.backgroundColor;
            let textColor = codeStyle.color;

            if (theme === 'dracula') {
                bgColor = '#282a36'; // ë°°ê²½ ê³ ì •
            } else if (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent') {
                const rgb = textColor.match(/\d+/g);
                if (rgb) {
                    const brightness = (parseInt(rgb[0]) * 299 + parseInt(rgb[1]) * 587 + parseInt(rgb[2]) * 114) / 1000;
                    bgColor = (brightness < 128) ? '#ffffff' : '#1e1e1e';
                } else {
                    bgColor = '#1e1e1e';
                }
            }
            
            const isDarkBg = (bgColor !== '#ffffff' && bgColor !== 'rgb(255, 255, 255)');

            // 3. ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ & Dracula JSON ìƒ‰ìƒ ë³´ì •
            tempCode.querySelectorAll('span').forEach(span => {
                const style = window.getComputedStyle(span);
                let color = style.color;
                let fontWeight = style.fontWeight;

                // [Dracula JSON ê°€ë…ì„± ë³´ì •]
                // ì›ë˜ í…Œë§ˆ ìƒ‰ìƒì„ ìœ ì§€í•˜ë˜, íšŒìƒ‰ ë“± ì˜ ì•ˆ ë³´ì´ëŠ” ìƒ‰ë§Œ Dracula íŒ”ë ˆíŠ¸ë¡œ êµì²´
                if (theme === 'dracula' && lang === 'json') {
                    if (span.classList.contains('hljs-attr')) {
                        // Key ê°’ (ì†ì„±ëª…): Cyan (#8be9fd)
                        color = '#8be9fd'; 
                    } else if (span.classList.contains('hljs-string')) {
                        // ë¬¸ìì—´ ê°’: Yellow (#f1fa8c) ë˜ëŠ” Green (#50fa7b)
                        color = '#f1fa8c';
                    } else if (span.classList.contains('hljs-number') || span.classList.contains('hljs-literal')) {
                        // ìˆ«ì, ë¶ˆë¦¬ì–¸: Purple (#bd93f9)
                        color = '#bd93f9';
                    }
                }

                span.style.color = color;
                span.style.fontWeight = fontWeight;
                span.removeAttribute('class');
            });

            // 4. ì¤„ ë¶„ë¦¬
            let lines = tempCode.innerHTML.split(/\r\n|\r|\n/);

            // [ì¬í™•ì¸] ë§¨ ì•ì¤„ì´ ë¹„ì–´ìˆìœ¼ë©´ ì œê±° (ë Œë”ë§ í›„ í•œë²ˆ ë” ì²´í¬)
            if (lines.length > 0 && lines[0].replace(/&nbsp;/g, '').trim() === '') {
                lines.shift();
            }
             if (lines.length > 0 && lines[lines.length - 1].replace(/&nbsp;/g, '').trim() === '') {
                lines.pop();
            }

            let lineNumbersHtml = '';
            let codeHtml = '';
            const lineHeight = Math.round(fontSize * 1.5); 

            lines.forEach((lineContent, index) => {
                if (lineContent.length === 0) lineContent = ' ';
                let processedLine = lineContent.replace(/  /g, '&nbsp;&nbsp;');
                
                lineNumbersHtml += `<div style="height: ${lineHeight}px; line-height: ${lineHeight}px;">${index + 1}</div>`;
                codeHtml += `<div style="height: ${lineHeight}px; line-height: ${lineHeight}px; white-space: pre; outline: none;">${processedLine}</div>`;
            });

            // 5. í—¤ë”
            let headerHtml = '';
            if (title) {
                const titleSize = Math.max(12, fontSize - 1);
                const headerBg = isDarkBg ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';
                const headerBorder = isDarkBg ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                headerHtml = `<div contenteditable="true" style="background-color: ${headerBg}; padding: 8px 15px; border-bottom: 1px solid ${headerBorder}; font-family: sans-serif; font-size: ${titleSize}px; font-weight: bold; color: ${textColor}; opacity: 0.9; outline: none;">${title}</div>`;
            }

            // 6. ìµœì¢… HTML
            const finalHtml = `<!-- ì½”ë“œ ë¸”ë¡ ì‹œì‘ -->
<div style="background-color: ${bgColor}; color: ${textColor}; border-radius: 8px; overflow: hidden; margin: 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-family: Consolas, 'Courier New', monospace; font-size: ${fontSize}px;">
${headerHtml}
<div style="display: flex; flex-direction: row; padding: 12px 0;">
<div style="user-select: none; -webkit-user-select: none; text-align: right; padding: 0 10px 0 15px; margin-right: 10px; border-right: 1px solid rgba(128, 128, 128, 0.3); color: ${isDarkBg ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)'}; min-width: 30px; font-family: inherit; pointer-events: none;">
${lineNumbersHtml}
</div>
<div contenteditable="true" style="flex: 1; overflow-x: auto; padding-right: 12px; font-family: inherit; white-space: pre; outline: none;">
${codeHtml}
</div>
</div>
</div>
<!-- ì½”ë“œ ë¸”ë¡ ë -->`;

            document.getElementById('output-html').value = finalHtml.trim();
            document.getElementById('preview-content').innerHTML = finalHtml;
        }

        function copyResult() {
            const outputText = document.getElementById('output-html');
            if (!outputText.value) { alert("ë¨¼ì € [ë³€í™˜í•˜ê¸°]ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”."); return; }
            outputText.select();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(outputText.value).then(() => alert('HTML ë³µì‚¬ ì™„ë£Œ!')).catch(err => alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err));
            } else {
                document.execCommand('copy');
                alert('HTML ë³µì‚¬ ì™„ë£Œ!');
            }
        }
        
        window.onload = function() {
            loadExample(); // ì´ˆê¸° ë¡œë”© ì‹œ Hello World ì˜ˆì œ ìë™ ë¡œë“œ
        }
    </script>
</body>
</html>
